<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Flag low-quality features — flag_quality • notame</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Flag low-quality features — flag_quality"><meta name="description" content="Flags low-quality features using the quality metrics defined in (Broadhurst
2018). The metrics are described in more detain in Details. A condition for
keeping the features is given as a character, which is passed to
filter."><meta property="og:description" content="Flags low-quality features using the quality metrics defined in (Broadhurst
2018). The metrics are described in more detain in Details. A condition for
keeping the features is given as a character, which is passed to
filter."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">notame</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/introduction.html">General introduction</a></li>
    <li><a class="dropdown-item" href="../articles/project_example.html">Project example</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hanhineva-lab/notame/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Flag low-quality features</h1>
      <small class="dont-index">Source: <a href="https://github.com/hanhineva-lab/notame/blob/main/R/quality_metrics.R" class="external-link"><code>R/quality_metrics.R</code></a></small>
      <div class="d-none name"><code>flag_quality.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Flags low-quality features using the quality metrics defined in (Broadhurst
2018). The metrics are described in more detain in Details. A condition for
keeping the features is given as a character, which is passed to
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="va">flag_quality</span></span>
<span><span class="fu">flag_quality</span><span class="op">(</span><span class="va">object</span>, assay.type <span class="op">=</span> <span class="cn">NULL</span>, condition <span class="op">=</span></span>
<span>  <span class="st">"(RSD_r &lt; 0.2 &amp; D_ratio_r &lt; 0.4) | </span></span>
<span><span class="st">  (RSD &lt; 0.1 &amp; RSD_r &lt; 0.1 &amp; D_ratio &lt; 0.1)"</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>a <code>
<a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">SummarizedExperiment</a></code>
or <code><a href="MetaboSet-class.html">MetaboSet</a></code> object</p></dd>


<dt id="arg-assay-type">assay.type<a class="anchor" aria-label="anchor" href="#arg-assay-type"></a></dt>
<dd><p>character, assay to be used in case of multiple assays</p></dd>


<dt id="arg-condition">condition<a class="anchor" aria-label="anchor" href="#arg-condition"></a></dt>
<dd><p>character, condition for keeping the features, see Details</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>a SummarizedExperiment or MetaboSet object with the features flagged.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The quality metrics measure two things: internal spread of the QCs,
and spread of the QCs compared to the spread of the biological samples.
Internal spread is measured with relative standard deviation (RSD), also
known as coefficient of variation (CV).
$$RSD = sd(QC) / mean(QC) $$
Where \(sd(QC)\) is the standard deviation of the QC samples and
'\(mean(QC)\) is the sample mean of the signal in the QC samples.
RSD can also be replaced by a non-parametric, robust version based on the
median and median absolute deviation (MAD):
  $$RSD_r = 1.4826 * MAD(QC) / median(QC)$$
The spread of the QC samples compared to the biological samples is measured
using a metric called D-ratio:
  $$D_ratio = sd(QC) / sd(biological)$$
Or, as before, a non-parametric, robust alternative:
  $$D_ratio_r = MAD(QC) / MAD(biolofical) $$
The default condition keeps features that pass either of the two following
conditions:
$$RSD_r &lt; 0.2 \&amp; D_ratio_r &lt; 0.4$$
$$RSD &lt; 0.1 \&amp; RSD_r &lt; 0.1 \&amp; D_ratio &lt; 0.1$$</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Broadhurst, David et al. Guidelines and considerations for the
use of system suitability and quality control samples in mass spectrometry
assays applied in untargeted clinical metabolomic studies.
Metabolomics : Official journal of the Metabolomic Society vol. 14,6 (2018):
72. doi:10.1007/s11306-018-1367-3</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_set</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ex_set</span> <span class="op">&lt;-</span> <span class="fu">flag_quality</span><span class="op">(</span><span class="va">example_set</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO [2025-06-23 22:36:34] </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 92% of features flagged for low quality</span>
<span class="r-in"><span><span class="fu">rowData</span><span class="op">(</span><span class="va">ex_set</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> DataFrame with 80 rows and 12 columns</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                       Feature_ID       Split Alignment</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                      &lt;character&gt; &lt;character&gt; &lt;integer&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_259_9623a4_4322 HILIC_neg_259_9623a4..   HILIC_neg         1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_108_1065a2_6121 HILIC_neg_108_1065a2..   HILIC_neg         2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_158_23a1_4128   HILIC_neg_158_23a1_4..   HILIC_neg         3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_251_0056a0_6161 HILIC_neg_251_0056a0..   HILIC_neg         4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_401_52a4_211    HILIC_neg_401_52a4_211   HILIC_neg         5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ...                                          ...         ...       ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_226_7218a3_1371    RP_pos_226_7218a3_1371      RP_pos        16</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_280_3779a4_0424    RP_pos_280_3779a4_0424      RP_pos        17</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_447_3232a2_2393    RP_pos_447_3232a2_2393      RP_pos        18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_453_282a5_128        RP_pos_453_282a5_128      RP_pos        19</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_153_9636a7_9986    RP_pos_153_9636a7_9986      RP_pos        20</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           Average_Mz Average_Rt_min      Column    Ion_mode</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                            &lt;numeric&gt;      &lt;numeric&gt; &lt;character&gt; &lt;character&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_259_9623a4_4322    259.962       4.432241       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_108_1065a2_6121    108.107       2.612073       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_158_23a1_4128      158.230       1.412822       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_251_0056a0_6161    251.006       0.616145       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_401_52a4_211       401.520       4.210970       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ...                              ...            ...         ...         ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_226_7218a3_1371       226.722        3.13714          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_280_3779a4_0424       280.378        4.04238          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_447_3232a2_2393       447.323        2.23926          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_453_282a5_128         453.282        5.12797          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_153_9636a7_9986       153.964        7.99864          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                  Flag       RSD     RSD_r   D_ratio D_ratio_r</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_259_9623a4_4322 Low_quality  0.127075  0.156465  0.363022  0.475271</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_108_1065a2_6121 Low_quality  0.468943  0.375347  1.202952  1.223426</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_158_23a1_4128   Low_quality  0.568911  0.188623  1.019238  0.509172</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_251_0056a0_6161 Low_quality  0.366231  0.383584  0.875327  1.089626</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_401_52a4_211    Low_quality  0.153478  0.222952  0.419890  0.710290</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ...                               ...       ...       ...       ...       ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_226_7218a3_1371    Low_quality  0.419258  0.298690  0.986842  1.069176</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_280_3779a4_0424             NA  0.126026  0.173915  0.253066  0.370787</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_447_3232a2_2393    Low_quality  0.729257  0.948402  1.106946  1.207068</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_453_282a5_128      Low_quality  0.663424  1.133718  1.465057  2.228991</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_153_9636a7_9986    Low_quality  0.570564  0.183891  1.075597  0.439143</span>
<span class="r-in"><span><span class="co"># Custom condition</span></span></span>
<span class="r-in"><span><span class="va">ex_set</span> <span class="op">&lt;-</span> <span class="fu">flag_quality</span><span class="op">(</span><span class="va">example_set</span>, </span></span>
<span class="r-in"><span>  condition <span class="op">=</span> <span class="st">"RSD_r &lt; 0.3 &amp; D_ratio_r &lt; 0.6"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO [2025-06-23 22:36:35] </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 70% of features flagged for low quality</span>
<span class="r-in"><span><span class="fu">rowData</span><span class="op">(</span><span class="va">ex_set</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> DataFrame with 80 rows and 12 columns</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                       Feature_ID       Split Alignment</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                      &lt;character&gt; &lt;character&gt; &lt;integer&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_259_9623a4_4322 HILIC_neg_259_9623a4..   HILIC_neg         1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_108_1065a2_6121 HILIC_neg_108_1065a2..   HILIC_neg         2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_158_23a1_4128   HILIC_neg_158_23a1_4..   HILIC_neg         3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_251_0056a0_6161 HILIC_neg_251_0056a0..   HILIC_neg         4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_401_52a4_211    HILIC_neg_401_52a4_211   HILIC_neg         5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ...                                          ...         ...       ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_226_7218a3_1371    RP_pos_226_7218a3_1371      RP_pos        16</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_280_3779a4_0424    RP_pos_280_3779a4_0424      RP_pos        17</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_447_3232a2_2393    RP_pos_447_3232a2_2393      RP_pos        18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_453_282a5_128        RP_pos_453_282a5_128      RP_pos        19</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_153_9636a7_9986    RP_pos_153_9636a7_9986      RP_pos        20</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           Average_Mz Average_Rt_min      Column    Ion_mode</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                            &lt;numeric&gt;      &lt;numeric&gt; &lt;character&gt; &lt;character&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_259_9623a4_4322    259.962       4.432241       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_108_1065a2_6121    108.107       2.612073       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_158_23a1_4128      158.230       1.412822       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_251_0056a0_6161    251.006       0.616145       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_401_52a4_211       401.520       4.210970       HILIC         neg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ...                              ...            ...         ...         ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_226_7218a3_1371       226.722        3.13714          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_280_3779a4_0424       280.378        4.04238          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_447_3232a2_2393       447.323        2.23926          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_453_282a5_128         453.282        5.12797          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_153_9636a7_9986       153.964        7.99864          RP         pos</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                  Flag       RSD     RSD_r   D_ratio D_ratio_r</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_259_9623a4_4322          NA  0.127075  0.156465  0.363022  0.475271</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_108_1065a2_6121 Low_quality  0.468943  0.375347  1.202952  1.223426</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_158_23a1_4128            NA  0.568911  0.188623  1.019238  0.509172</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_251_0056a0_6161 Low_quality  0.366231  0.383584  0.875327  1.089626</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> HILIC_neg_401_52a4_211    Low_quality  0.153478  0.222952  0.419890  0.710290</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ...                               ...       ...       ...       ...       ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_226_7218a3_1371    Low_quality  0.419258  0.298690  0.986842  1.069176</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_280_3779a4_0424             NA  0.126026  0.173915  0.253066  0.370787</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_447_3232a2_2393    Low_quality  0.729257  0.948402  1.106946  1.207068</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_453_282a5_128      Low_quality  0.663424  1.133718  1.465057  2.228991</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RP_pos_153_9636a7_9986             NA  0.570564  0.183891  1.075597  0.439143</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anton Klåvus, Jussi Paananen, Oskari Timonen, Atte Lihtamo, Vilhelm Suksi, Retu Haikonen, Leo Lahti, Kati Hanhineva.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

