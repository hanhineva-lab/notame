<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Project example • notame</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Project example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">notame</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">General introduction</a></li>
    <li><a class="dropdown-item" href="../articles/project_example.html">Project example</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hanhineva-lab/notame/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Project example</h1>
                        <h4 data-toc-skip class="author">Anton Klåvus,
Vilhelm Suksi</h4>
            
            <h4 data-toc-skip class="date">2025-06-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hanhineva-lab/notame/blob/main/vignettes/project_example.Rmd" class="external-link"><code>vignettes/project_example.Rmd</code></a></small>
      <div class="d-none name"><code>project_example.Rmd</code></div>
    </div>

    
    
<p>In this project example, core functionality of <em>notame</em> is
demonstrated in unison with the associated protocol article <span class="citation">(Klåvus et al. 2020)</span>. Since substantive insight
is not a focus of the project example, results visualizations are
omitted.</p>
<div class="section level2">
<h2 id="project-setup">Project setup<a class="anchor" aria-label="anchor" href="#project-setup"></a>
</h2>
<div class="section level3">
<h3 id="set-up-path-and-logging">Set up path and logging<a class="anchor" aria-label="anchor" href="#set-up-path-and-logging"></a>
</h3>
<p>Let’s set up a path and start logging our project. Many functions of
the package will log information when they have finished. This helps in
monitoring the analysis process in case something goes wrong and in
reviewing the results later. The log will also print to console,
although we’ll exclude console output for the rest of the document for
brevity.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hanhineva-lab/notame" class="external-link">notame</a></span><span class="op">)</span></span>
<span><span class="va">ppath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/init_log.html">init_log</a></span><span class="op">(</span>log_file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"log.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## INFO [2025-06-23 22:38:51] Starting logging</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="read-data">Read data<a class="anchor" aria-label="anchor" href="#read-data"></a>
</h3>
<p>The data is mock data with two balanced groups and two balanced time
points. The time points also correspond to two batches. There are 50
samples with ten regularly interspersed QC samples and 80 features
divided into four analytical modes.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_from_excel.html">read_from_excel</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example_set.xlsx"</span>, package <span class="op">=</span> <span class="st">"notame"</span><span class="op">)</span>, </span>
<span>  sheet <span class="op">=</span> <span class="fl">1</span>, corner_row <span class="op">=</span> <span class="fl">11</span>, corner_column <span class="op">=</span> <span class="st">"H"</span>, </span>
<span>  split_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Column"</span>, <span class="st">"Ion_mode"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The function read_from_excel() returns a list holding the three parts
of the data:</p>
<ul>
<li>
<code>exprs</code>: feature abundances across the samples<br>
</li>
<li>
<code>pheno_data</code>: sample information<br>
</li>
<li>
<code>feature_data</code>: feature information</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">## [1] "exprs"        "pheno_data"   "feature_data"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="co">## $exprs</span></span>
<span><span class="co">## [1] "matrix" "array" </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $pheno_data</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $feature_data</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">dim</span><span class="op">)</span></span>
<span><span class="co">##      exprs pheno_data feature_data</span></span>
<span><span class="co">## [1,]    80         50           80</span></span>
<span><span class="co">## [2,]    50         11            8</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="construct-summarizedexperiment-object">Construct SummarizedExperiment object<a class="anchor" aria-label="anchor" href="#construct-summarizedexperiment-object"></a>
</h3>
<p>These three parts can be used to construct SummarizedExperiment using
the native SummarizedExperiment constructor or MetaboSet objects using
<code><a href="../reference/construct_metabosets.html">construct_metabosets()</a></code>. The example data contains four
analytical modes, so we separate them using <code><a href="../reference/fix_object.html">fix_object()</a></code>,
which also conveniently checks the object for compatibility with all of
notame.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">SummarizedExperiment</a></span><span class="op">(</span>assays <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">exprs</span>, </span>
<span>                             rowData <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">feature_data</span>,</span>
<span>                             colData <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">pheno_data</span><span class="op">)</span></span>
<span>                             </span>
<span><span class="va">modes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fix_object.html">fix_object</a></span><span class="op">(</span><span class="va">data</span>, split_data <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Now we have a list of objects, one per mode (LC column x ionization
mode) or whatever split was supplied to
<code><a href="../reference/read_from_excel.html">read_from_excel()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">modes</span><span class="op">)</span></span>
<span><span class="co">## [1] "HILIC_neg" "HILIC_pos" "RP_neg"    "RP_pos"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">modes</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="co">##              HILIC_neg              HILIC_pos                 RP_neg </span></span>
<span><span class="co">## "SummarizedExperiment" "SummarizedExperiment" "SummarizedExperiment" </span></span>
<span><span class="co">##                 RP_pos </span></span>
<span><span class="co">## "SummarizedExperiment"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="tabular-data-preprocessing">Tabular data preprocessing<a class="anchor" aria-label="anchor" href="#tabular-data-preprocessing"></a>
</h2>
<div class="section level3">
<h3 id="preprocessing-by-mode">Preprocessing by mode<a class="anchor" aria-label="anchor" href="#preprocessing-by-mode"></a>
</h3>
<p>Tabular data preprocessing is performed to complete the dataset by
way of reducing unwanted variation and data preparation dependent on
downstream methods. Steps performed separately for each mode include
marking missing values as NA, flagging features with low detection rate
<span class="citation">(Broadhurst et al. 2018)</span>, drift correction
<span class="citation">(Kirwan et al. 2013)</span>, and flagging of
low-quality features <span class="citation">(Broadhurst et al.
2018)</span>. Visualizations are drawn to monitor the process and
explore the data globally. The <code><a href="../reference/visualizations.html">visualizations()</a></code> wrapper
does not include feature-wise plots as it may not be feasible to inspect
them at this stage of the analysis. For example, drift correction
visualizations are best drawn for a subset of interesting features after
feature selection.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize empty list for processed objects</span></span>
<span><span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">modes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">modes</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">mode</span> <span class="op">&lt;-</span> <span class="va">modes</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co"># Set all zero abundances to NA</span></span>
<span>  <span class="va">mode</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mark_nas.html">mark_nas</a></span><span class="op">(</span><span class="va">mode</span>, value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="co"># Flag features with low detection rate</span></span>
<span>  <span class="va">mode</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_detection.html">flag_detection</a></span><span class="op">(</span><span class="va">mode</span>, group <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span>
<span>  <span class="co"># Visualize data before drift correction</span></span>
<span>  <span class="fu"><a href="../reference/visualizations.html">visualizations</a></span><span class="op">(</span><span class="va">mode</span>, prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"figures/"</span>, <span class="va">name</span>, <span class="st">"_ORIG"</span><span class="op">)</span>,</span>
<span>                 perplexity <span class="op">=</span> <span class="fl">5</span>, group <span class="op">=</span> <span class="st">"Group"</span>, time <span class="op">=</span> <span class="st">"Time"</span>, </span>
<span>                 id <span class="op">=</span> <span class="st">"Subject_ID"</span>, color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span>
<span>  <span class="co"># Correct drift</span></span>
<span>  <span class="va">corrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/correct_drift.html">correct_drift</a></span><span class="op">(</span><span class="va">mode</span><span class="op">)</span></span>
<span>  <span class="co"># Visualize data after drift correction</span></span>
<span>  <span class="fu"><a href="../reference/visualizations.html">visualizations</a></span><span class="op">(</span><span class="va">corrected</span>, prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"figures/"</span>, <span class="va">name</span>, <span class="st">"_DRIFT"</span><span class="op">)</span>,</span>
<span>                 perplexity <span class="op">=</span> <span class="fl">5</span>, group <span class="op">=</span> <span class="st">"Group"</span>, time <span class="op">=</span> <span class="st">"Time"</span>, </span>
<span>                 id <span class="op">=</span> <span class="st">"Subject_ID"</span>, color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span>
<span>  <span class="co"># Flag low-quality features</span></span>
<span>  <span class="va">corrected</span> <span class="op">&lt;-</span> <span class="va">corrected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/assess_quality.html">assess_quality</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/flag_quality.html">flag_quality</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># Visualize data after removal of low-quality features</span></span>
<span>  <span class="fu"><a href="../reference/visualizations.html">visualizations</a></span><span class="op">(</span><span class="va">corrected</span>, prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"figures/"</span>, <span class="va">name</span>, <span class="st">"_CLEAN"</span><span class="op">)</span>,</span>
<span>                 perplexity <span class="op">=</span> <span class="fl">5</span>, group <span class="op">=</span> <span class="st">"Group"</span>, time <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>                 id <span class="op">=</span> <span class="st">"Subject_ID"</span>, color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span>
<span>  <span class="co"># Save result of iteration</span></span>
<span>  <span class="va">processed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">corrected</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Feature-wise flagging information, quality metrics, and brief drift
correction notes are included in the feature information after the above
steps. The <code><a href="../reference/correct_drift.html">correct_drift()</a></code> function performs drift
correction on all features with sufficient detection in QC samples by
default. In case <code>check_quality = TRUE</code>,
<code><a href="../reference/correct_drift.html">correct_drift()</a></code> retains corrected values only for features
with improved quality metrics after drift correction, along with a note
documenting this action in feature information.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">processed</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">DC_note</span></span>
<span><span class="co">##  [1] "Drift_corrected" "Drift_corrected" "Drift_corrected" "Drift_corrected"</span></span>
<span><span class="co">##  [5] "Drift_corrected" "Drift_corrected" "Drift_corrected" "Drift_corrected"</span></span>
<span><span class="co">##  [9] "Drift_corrected" "Drift_corrected" "Drift_corrected" "Drift_corrected"</span></span>
<span><span class="co">## [13] "Drift_corrected" "Drift_corrected" "Drift_corrected" "Drift_corrected"</span></span>
<span><span class="co">## [17] "Drift_corrected" "Drift_corrected" "Drift_corrected" "Drift_corrected"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preprocessing-for-the-complete-dataset">Preprocessing for the complete dataset<a class="anchor" aria-label="anchor" href="#preprocessing-for-the-complete-dataset"></a>
</h3>
<p>Next, it is time to merge the modes together and visualize the
complete dataset.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_objects.html">merge_objects</a></span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/visualizations.html">visualizations</a></span><span class="op">(</span><span class="va">merged</span>, prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"figures/_FULL"</span><span class="op">)</span>,</span>
<span>               group <span class="op">=</span> <span class="st">"Group"</span>, time <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>               id <span class="op">=</span> <span class="st">"Subject_ID"</span>, color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span></code></pre></div>
<p>Then, QC samples can (and should) be removed, as they are no longer
needed, and the dataset is visualized anew.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">merged_no_qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/drop_qcs.html">drop_qcs</a></span><span class="op">(</span><span class="va">merged</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/visualizations.html">visualizations</a></span><span class="op">(</span><span class="va">merged_no_qc</span>, prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"figures/FULL_NO_QC"</span><span class="op">)</span>,</span>
<span>               group <span class="op">=</span> <span class="st">"Group"</span>, time <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>               id <span class="op">=</span> <span class="st">"Subject_ID"</span>, color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span></code></pre></div>
<p>If there are any missing values in the data, they need to be imputed.
Let’s use random forest imputation to impute these values and visualize
the dataset one last time before statistical analysis. Seed number
should be set before random forest imputation to guarantee
reproducibility of results.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">imputed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_rf.html">impute_rf</a></span><span class="op">(</span><span class="va">merged_no_qc</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/visualizations.html">visualizations</a></span><span class="op">(</span><span class="va">imputed</span>, prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"figures/FULL_IMPUTED"</span><span class="op">)</span>,</span>
<span>               group <span class="op">=</span> <span class="st">"Group"</span>, time <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>               id <span class="op">=</span> <span class="st">"Subject_ID"</span>, color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span></code></pre></div>
<p>By default, the imputation procedure only operates on good quality
features, i.e. those that have not been flagged. To use flagged features
in statistical analysis, they should be imputed as well. This can be
achieved through a second round of imputation, now with all features
included. This two-step imputation makes sure that low-quality features
don’t affect the imputation of quality features. Imputation could also
be performed separately for each mode to reduce execution time,
especially if the amounts of features still allows for good imputation
results.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_rf.html">impute_rf</a></span><span class="op">(</span><span class="va">imputed</span>, all_features <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>It is a good idea to save the merged and processed data, so
experimenting with different statistical analyses becomes easier.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">base</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"full_data.RData"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="feature-selection">Feature selection<a class="anchor" aria-label="anchor" href="#feature-selection"></a>
</h2>
<div class="section level3">
<h3 id="univariate-analysis">Univariate analysis<a class="anchor" aria-label="anchor" href="#univariate-analysis"></a>
</h3>
<p>First, we’ll use a linear model to evaluate the features in terms of
the probability of obtaining the observed abundances given the null
hypothesis, namely that there is no difference in feature abundance
across study groups.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perform_lm.html">perform_lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/log.html">log</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, formula_char <span class="op">=</span> <span class="st">"Feature ~ Group"</span><span class="op">)</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_rowData.html">join_rowData</a></span><span class="op">(</span><span class="va">base</span>, <span class="va">lm_results</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="supervised-learning">Supervised learning<a class="anchor" aria-label="anchor" href="#supervised-learning"></a>
</h3>
<p>Univariate hypothesis testing does not take into account the
multivariate, interconnected nature of the data. Parametric tests as the
one above also make assumptions about the data which may undermine the
reliability of the results, as they are likely to be violated in
untargeted LC-MS datasets. Let’s use supervised learning to see which
features best predict group membership to get another perspective. A
random forest model doesn’t require further preprocessing and makes
minimal assumptions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rf.html">fit_rf</a></span><span class="op">(</span><span class="va">base</span>, y <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_importance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importance_rf.html">importance_rf</a></span><span class="op">(</span><span class="va">rf_results</span><span class="op">)</span></span>
<span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_rowData.html">join_rowData</a></span><span class="op">(</span><span class="va">base</span>, </span>
<span>  <span class="va">rf_importance</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Feature_ID"</span>, <span class="st">"MeanDecreaseAccuracy"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Next, univariate and supervised rankings of features could be
combined in a final ranking. Such a final ranking would combine the
qualities of univariate analysis and supervised learning. The final
results are more practical than inferential; it helps in limiting the
number of features undergoing labour- intensive scrutiny for biological
meaning, for example by identification and pathway analysis. This may
ultimately guide further efforts in productive directions. For example,
in biomarker discovery, the results may prompt validation using targeted
LC-MS.</p>
<p>That concludes our project example. The last thing to do is to write
the results to an Excel file and finish the logging. Thanks!</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/write_to_excel.html">write_to_excel</a></span><span class="op">(</span><span class="va">base</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ppath</span>, <span class="st">"results.xlsx"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/finish_log.html">finish_log</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<pre><code><span><span class="co">## R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.2 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] notame_0.99.2               SummarizedExperiment_1.38.1</span></span>
<span><span class="co">##  [3] GenomicRanges_1.60.0        GenomeInfoDb_1.44.0        </span></span>
<span><span class="co">##  [5] IRanges_2.42.0              S4Vectors_0.46.0           </span></span>
<span><span class="co">##  [7] MatrixGenerics_1.20.0       matrixStats_1.5.0          </span></span>
<span><span class="co">##  [9] magrittr_2.0.3              ggplot2_3.5.2              </span></span>
<span><span class="co">## [11] Biobase_2.68.0              BiocGenerics_0.54.0        </span></span>
<span><span class="co">## [13] generics_0.1.4              BiocStyle_2.36.0           </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] tidyselect_1.2.1        viridisLite_0.4.2       dplyr_1.1.4            </span></span>
<span><span class="co">##  [4] farver_2.1.2            fastmap_1.2.0           digest_0.6.37          </span></span>
<span><span class="co">##  [7] lifecycle_1.0.4         compiler_4.5.1          rngtools_1.5.2         </span></span>
<span><span class="co">## [10] rlang_1.1.6             sass_0.4.10             tools_4.5.1            </span></span>
<span><span class="co">## [13] yaml_2.3.10             knitr_1.50              lambda.r_1.2.4         </span></span>
<span><span class="co">## [16] doRNG_1.8.6.2           S4Arrays_1.8.1          labeling_0.4.3         </span></span>
<span><span class="co">## [19] htmlwidgets_1.6.4       DelayedArray_0.34.1     RColorBrewer_1.1-3     </span></span>
<span><span class="co">## [22] abind_1.4-8             BiocParallel_1.42.1     Rtsne_0.17             </span></span>
<span><span class="co">## [25] withr_3.0.2             purrr_1.0.4             itertools_0.1-3        </span></span>
<span><span class="co">## [28] desc_1.4.3              grid_4.5.1              scales_1.4.0           </span></span>
<span><span class="co">## [31] iterators_1.0.14        MASS_7.3-65             cli_3.6.5              </span></span>
<span><span class="co">## [34] rmarkdown_2.29          crayon_1.5.3            ragg_1.4.0             </span></span>
<span><span class="co">## [37] httr_1.4.7              cachem_1.1.0            parallel_4.5.1         </span></span>
<span><span class="co">## [40] formatR_1.14            BiocManager_1.30.26     XVector_0.48.0         </span></span>
<span><span class="co">## [43] vctrs_0.6.5             Matrix_1.7-3            jsonlite_2.0.0         </span></span>
<span><span class="co">## [46] bookdown_0.43           systemfonts_1.2.3       foreach_1.5.2          </span></span>
<span><span class="co">## [49] jquerylib_0.1.4         tidyr_1.3.1             ggdendro_0.2.0         </span></span>
<span><span class="co">## [52] missForest_1.5          glue_1.8.0              pkgdown_2.1.3          </span></span>
<span><span class="co">## [55] codetools_0.2-20        cowplot_1.1.3           stringi_1.8.7          </span></span>
<span><span class="co">## [58] gtable_0.3.6            futile.logger_1.4.3     UCSC.utils_1.4.0       </span></span>
<span><span class="co">## [61] tibble_3.3.0            pillar_1.10.2           pcaMethods_2.0.0       </span></span>
<span><span class="co">## [64] htmltools_0.5.8.1       randomForest_4.7-1.2    GenomeInfoDbData_1.2.14</span></span>
<span><span class="co">## [67] R6_2.6.1                textshaping_1.0.1       evaluate_1.0.4         </span></span>
<span><span class="co">## [70] lattice_0.22-7          futile.options_1.0.1    openxlsx_4.2.8         </span></span>
<span><span class="co">## [73] bslib_0.9.0             Rcpp_1.0.14             zip_2.3.3              </span></span>
<span><span class="co">## [76] SparseArray_1.8.0       xfun_0.52               fs_1.6.6               </span></span>
<span><span class="co">## [79] pkgconfig_2.0.3</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-qcguidelines" class="csl-entry">
Broadhurst, David, Royston Goodacre, Stacey N Reinke, Julia Kuligowski,
Ian D Wilson, Matthew R Lewis, and Warwick B Dunn. 2018.
<span>“Guidelines and Considerations for the Use of System Suitability
and Quality Control Samples in Mass Spectrometry Assays Applied in
Untargeted Clinical Metabolomic Studies.”</span> <em>Metabolomics</em>
14: 1–17.
</div>
<div id="ref-driftcorrection" class="csl-entry">
Kirwan, JA, DI Broadhurst, RL Davidson, and MR Viant. 2013.
<span>“Characterising and Correcting Batch Variation in an Automated
Direct Infusion Mass Spectrometry (DIMS) Metabolomics Workflow.”</span>
<em>Analytical and Bioanalytical Chemistry</em> 405: 5147–57.
</div>
<div id="ref-notame" class="csl-entry">
Klåvus, Anton, Marietta Kokla, Stefania Noerman, Ville M Koistinen,
Marjo Tuomainen, Iman Zarei, Topi Meuronen, et al. 2020.
<span>“<span>‘Notame’</span>: Workflow for Non-Targeted LC–MS Metabolic
Profiling.”</span> <em>Metabolites</em> 10 (4): 135.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anton Klåvus, Jussi Paananen, Oskari Timonen, Atte Lihtamo, Vilhelm Suksi, Retu Haikonen, Leo Lahti, Kati Hanhineva.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
